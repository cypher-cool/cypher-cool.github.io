<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>WebP图片下拉选择器</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      min-height: 100vh;
      background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 50%, #43cea2 100%);
    }
    .container { max-width: 600px; margin: auto; background: rgba(255,255,255,0.92); border-radius: 18px; box-shadow: 0 4px 24px rgba(67,206,162,0.10); padding: 32px 24px 24px 24px; }
    label { display: block; margin-bottom: 10px; }
    select, input[type="file"] { width: 100%; margin-bottom: 20px; }
    .img-container {
      position: relative;
      text-align: center;
      margin-top: 40px;
      min-height: 400px;
    }
    .img-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.9);
      border: 1px solid #ccc;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 26px;
      cursor: pointer;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      pointer-events: auto;
    }
    .img-btn:hover { background: #f0f0f0; }
    #prev-btn { left: -60px; }
    #next-btn { right: -60px; }
    .zoom-controls {
      position: absolute;
      right: -80px;
      top: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 20;
      pointer-events: auto;
    }
    .zoom-btn {
      background: rgba(255,255,255,0.9);
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 18px;
      cursor: pointer;
      margin: 0;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      pointer-events: auto;
    }
    .zoom-btn:hover { background: #f0f0f0; }
    .side-btns {
      position: absolute;
      right: -60px;
      top: calc(50% + 56px);
      z-index: 21;
      display: none;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }
    .action-btn {
      background: #43cea2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 7px 16px;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(67,206,162,0.10);
      transition: background 0.2s;
    }
    .action-btn:hover { background: #2ebd85; }
    img {
      display: block;
      max-width: 100%;
      max-height: 480px;
      min-height: 320px;
      margin: 0 auto;
      margin-top: 0;
      border: 1px solid #ccc;
      transition: transform 0.2s;
      background: #fafafa;
      z-index: 1;
      position: relative;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      pointer-events: none;
    }
    @media (max-width: 800px) {
      .container { max-width: 98vw; }
      #prev-btn, #next-btn { left: 0; right: 0; }
      .zoom-controls { right: 0; top: auto; bottom: -60px; flex-direction: row; }
      .side-btns { right: 0; top: auto; bottom: 10px; left: 0; margin: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>上传并选择WebP图片</h2>
    <label for="webp-upload">上传WebP图片（可多选）:</label>
    <input type="file" id="webp-upload" accept="image/webp" multiple>

    <label for="webp-select">选择图片:</label>
    <select id="webp-select">
      <option value="">-- 请选择图片 --</option>
    </select>

    <div class="img-container">
      <button id="prev-btn" class="img-btn" style="display:none;">←</button>
      <img id="preview" src="" alt="图片预览" style="display:none;" />
      <button id="next-btn" class="img-btn" style="display:none;">→</button>
      <div class="zoom-controls" id="zoom-controls" style="display:none;">
        <button id="zoom-in" class="zoom-btn">放大</button>
        <button id="zoom-out" class="zoom-btn">缩小</button>
      </div>
      <div class="side-btns" id="side-btns">
        <button id="delete-btn" class="action-btn">删除</button>
        <button id="rename-btn" class="action-btn">重命名</button>
      </div>
    </div>
  </div>

  <script>
    // IndexedDB工具
    const DB_NAME = 'webpImageDB';
    const STORE_NAME = 'images';
    let db;
    let imageList = [];
    let currentIdx = -1;
    let currentScale = 1;

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = function(e) {
          db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'name' });
          }
        };
        request.onsuccess = function(e) {
          db = e.target.result;
          resolve();
        };
        request.onerror = function(e) {
          reject(e);
        };
      });
    }

    function saveImageToDB(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const transaction = db.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          store.put({ name: file.name, data: e.target.result });
          transaction.oncomplete = resolve;
          transaction.onerror = reject;
        };
        reader.readAsDataURL(file);
      });
    }

    function getAllImagesFromDB() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();
        request.onsuccess = function(e) {
          resolve(e.target.result);
        };
        request.onerror = reject;
      });
    }

    function deleteImageFromDB(name) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(name);
        transaction.oncomplete = resolve;
        transaction.onerror = reject;
      });
    }

    function renameImageInDB(oldName, newName, data) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        store.delete(oldName);
        store.put({ name: newName, data });
        transaction.oncomplete = resolve;
        transaction.onerror = reject;
      });
    }

    // UI相关
    const uploadInput = document.getElementById('webp-upload');
    const select = document.getElementById('webp-select');
    const preview = document.getElementById('preview');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomControls = document.getElementById('zoom-controls');
    const sideBtns = document.getElementById('side-btns');
    const deleteBtn = document.getElementById('delete-btn');
    const renameBtn = document.getElementById('rename-btn');

    function updateSelectOptions() {
      select.innerHTML = '<option value="">-- 请选择图片 --</option>';
      imageList.forEach((img, idx) => {
        const option = document.createElement('option');
        option.value = img.name;
        option.textContent = img.name;
        select.appendChild(option);
      });
    }

    function showImage(idx) {
      if (idx < 0 || idx >= imageList.length) {
        preview.style.display = 'none';
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        zoomControls.style.display = 'none';
        sideBtns.style.display = 'none';
        select.value = '';
        currentIdx = -1;
        return;
      }
      const img = imageList[idx];
      preview.src = img.data;
      preview.style.display = 'block';
      select.value = img.name;
      currentIdx = idx;
      currentScale = 1;
      preview.style.transform = 'scale(1)';
      // 按钮显示逻辑
      prevBtn.style.display = (idx > 0) ? 'flex' : 'none';
      nextBtn.style.display = (idx < imageList.length - 1) ? 'flex' : 'none';
      zoomControls.style.display = 'flex';
      sideBtns.style.display = 'flex';
    }

    uploadInput.addEventListener('change', async function() {
      const files = Array.from(this.files).filter(f => f.type === 'image/webp');
      for (const file of files) {
        await saveImageToDB(file);
      }
      imageList = await getAllImagesFromDB();
      updateSelectOptions();
      if (imageList.length > 0) showImage(imageList.length - 1);
    });

    select.addEventListener('change', function() {
      const idx = imageList.findIndex(img => img.name === this.value);
      if (idx !== -1) {
        showImage(idx);
      }
    });

    prevBtn.addEventListener('click', function() {
      if (currentIdx > 0) {
        showImage(currentIdx - 1);
      }
    });
    nextBtn.addEventListener('click', function() {
      if (currentIdx < imageList.length - 1) {
        showImage(currentIdx + 1);
      }
    });
    zoomInBtn.addEventListener('click', function() {
      currentScale = Math.min(currentScale + 0.2, 5);
      preview.style.transform = `scale(${currentScale})`;
    });
    zoomOutBtn.addEventListener('click', function() {
      currentScale = Math.max(currentScale - 0.2, 0.2);
      preview.style.transform = `scale(${currentScale})`;
    });

    // 删除图片
    deleteBtn.addEventListener('click', async function() {
      if (currentIdx < 0 || currentIdx >= imageList.length) return;
      const delName = imageList[currentIdx].name;
      if (!confirm(`确定要删除图片“${delName}”吗？`)) return;
      await deleteImageFromDB(delName);
      imageList = await getAllImagesFromDB();
      let nextIdx = currentIdx;
      if (nextIdx >= imageList.length) nextIdx = imageList.length - 1;
      showImage(nextIdx);
      updateSelectOptions();
    });

    // 重命名图片
    renameBtn.addEventListener('click', async function() {
      if (currentIdx < 0 || currentIdx >= imageList.length) return;
      const oldName = imageList[currentIdx].name;
      let newName = prompt('请输入新图片名称（需以 .webp 结尾）：', oldName);
      if (!newName || newName === oldName) return;
      newName = newName.trim();
      if (!newName.toLowerCase().endsWith('.webp')) {
        alert('图片名称必须以 .webp 结尾！');
        return;
      }
      if (imageList.some(img => img.name === newName)) {
        alert('已存在同名图片，请更换名称！');
        return;
      }
      const data = imageList[currentIdx].data;
      await renameImageInDB(oldName, newName, data);
      imageList = await getAllImagesFromDB();
      const idx = imageList.findIndex(img => img.name === newName);
      showImage(idx);
      updateSelectOptions();
    });

    // 初始化
    openDB().then(async () => {
      imageList = await getAllImagesFromDB();
      updateSelectOptions();
      if (imageList.length > 0) showImage(0);
    });
  </script>
</body>
</html> 